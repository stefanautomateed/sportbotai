generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id                     String         @id @default(cuid())
  name                   String?
  email                  String?        @unique
  emailVerified          DateTime?
  image                  String?
  password               String?
  plan                   Plan           @default(FREE)
  stripeCustomerId       String?        @unique
  stripeSubscriptionId   String?        @unique
  stripePriceId          String?
  stripeCurrentPeriodEnd DateTime?
  analysisCount          Int            @default(0)
  lastAnalysisDate       DateTime?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  referralCampaign       String?
  referralMedium         String?
  referralSource         String?
  bannedReason           String?
  bonusCredits           Int            @default(0)
  isBanned               Boolean        @default(false)
  lastActiveAt           DateTime?
  accounts               Account[]
  analyses               Analysis[]
  favoriteTeams          FavoriteTeam[]
  sessions               Session[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Analysis {
  id            String    @id @default(cuid())
  userId        String
  sport         String
  league        String
  homeTeam      String
  awayTeam      String
  matchDate     DateTime?
  userPick      String?
  userStake     Float?
  homeWinProb   Float?
  drawProb      Float?
  awayWinProb   Float?
  riskLevel     String?
  bestValueSide String?
  fullResponse  Json?
  createdAt     DateTime  @default(now())
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model BlogKeyword {
  id              String        @id @default(cuid())
  keyword         String        @unique
  status          KeywordStatus @default(PENDING)
  lastGeneratedAt DateTime?
  generationCount Int           @default(0)
  searchVolume    Int?
  difficulty      Int?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  posts           BlogPost[]

  @@index([status])
  @@index([lastGeneratedAt])
}

model BlogPost {
  id                 String       @id @default(cuid())
  title              String
  slug               String       @unique
  excerpt            String
  content            String
  metaTitle          String?
  metaDescription    String?
  focusKeyword       String?
  featuredImage      String?
  imageAlt           String?
  category           String?
  tags               String[]
  status             PostStatus   @default(DRAFT)
  publishedAt        DateTime?
  keywordId          String?
  aiModel            String?
  generationCost     Float?
  views              Int          @default(0)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  awayTeam           String?
  finalScore         String?
  homeTeam           String?
  league             String?
  matchDate          DateTime?
  matchId            String?
  postMatchContent   String?
  postMatchUpdatedAt DateTime?
  postType           PostType     @default(GENERAL)
  sport              String?
  newsContent        String?
  newsTitle          String?
  
  // Serbian translations
  slugSr             String?
  titleSr            String?
  excerptSr          String?
  contentSr          String?
  metaTitleSr        String?
  metaDescriptionSr  String?
  newsTitleSr        String?
  newsContentSr      String?
  translatedAt       DateTime?    // When Serbian translation was done
  
  keyword            BlogKeyword? @relation(fields: [keywordId], references: [id])

  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([keywordId])
  @@index([matchId])
  @@index([matchDate])
  @@index([postType])
  @@index([translatedAt])
}

model FavoriteTeam {
  id             String   @id @default(cuid())
  userId         String
  teamName       String
  teamSlug       String
  sport          String
  league         String?
  sportKey       String?
  teamLogo       String?
  country        String?
  notifyMatches  Boolean  @default(true)
  notifyInjuries Boolean  @default(false)
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, teamSlug, sport])
  @@index([userId])
  @@index([teamSlug])
  @@index([sport])
}

model ChatQuery {
  id                 String    @id @default(cuid())
  query              String
  queryNormalized    String?
  category           String?
  brainMode          String?
  sport              String?
  team               String?
  league             String?
  usedRealTimeSearch Boolean   @default(false)
  responseLength     Int?
  hadCitations       Boolean   @default(false)
  queryHash          String?
  similarCount       Int       @default(1)
  createdAt          DateTime  @default(now())
  answer             String?
  citations          Json?
  expiresAt          DateTime?

  @@index([category])
  @@index([sport])
  @@index([team])
  @@index([queryHash])
  @@index([createdAt])
  @@index([expiresAt])
}

model TrendingTopic {
  id              String    @id @default(cuid())
  topic           String    @unique
  category        String?
  sport           String?
  queryCount      Int       @default(1)
  last24hCount    Int       @default(0)
  last7dCount     Int       @default(0)
  isSpike         Boolean   @default(false)
  spikeDetectedAt DateTime?
  lastFetchedAt   DateTime?
  cachedResponse  String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([queryCount])
  @@index([last24hCount])
  @@index([sport])
  @@index([isSpike])
}

model ChatFeedback {
  id                 String   @id @default(cuid())
  messageId          String
  queryHash          String
  query              String
  response           String
  rating             Int
  feedback           String?
  sport              String?
  category           String?
  brainMode          String?
  usedRealTimeSearch Boolean  @default(false)
  fromCache          Boolean  @default(false)
  userId             String?
  userPlan           String?
  createdAt          DateTime @default(now())

  @@index([messageId])
  @@index([queryHash])
  @@index([rating])
  @@index([userId])
  @@index([createdAt])
}

model AgentPost {
  id             String   @id @default(cuid())
  content        String
  category       String
  homeTeam       String?
  awayTeam       String?
  matchRef       String?
  league         String?
  sport          String?
  narrativeAngle String?
  publicMismatch String?
  clarityLevel   Int?
  confidence     Int?
  severity       Int?
  realTimeData   Boolean  @default(false)
  citations      String[]
  postedToX      Boolean  @default(false)
  xPostId        String?
  impressions    Int      @default(0)
  engagement     Int      @default(0)
  createdAt      DateTime @default(now())
  predictionId   String?

  @@index([category])
  @@index([homeTeam])
  @@index([awayTeam])
  @@index([createdAt])
  @@index([postedToX])
  @@index([predictionId])
}

model KnowledgeBase {
  id              String   @id @default(cuid())
  question        String
  answer          String
  sport           String?
  category        String?
  team            String?
  quality         Int      @default(3)
  useCount        Int      @default(1)
  citations       String[]
  hadRealTimeData Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sport])
  @@index([category])
  @@index([team])
  @@index([quality])
  @@index([useCount])
}

model SportExpertise {
  id              String   @id @default(cuid())
  sport           String   @unique
  topCategories   String[]
  commonQuestions String[]
  keyTerminology  String[]
  learnedFacts    String[]
  totalQueries    Int      @default(0)
  lastUpdated     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sport])
}

model Prediction {
  id                String           @id @default(cuid())
  matchId           String
  matchName         String
  sport             String
  league            String
  kickoff           DateTime
  type              CallType
  prediction        String
  reasoning         String
  conviction        Int
  odds              Float?
  impliedProb       Float?
  tweetId           String?
  validationTweetId String?
  outcome           CallOutcome      @default(PENDING)
  actualResult      String?
  validatedAt       DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  actualScore       String?
  source            PredictionSource @default(PRE_ANALYZE)
  closingOdds       Float?
  clvFetched        Boolean          @default(false)
  clvPercentage     Float?
  openingOdds       Float?
  valueBetEdge      Float?
  valueBetOdds      Float?
  valueBetOutcome   CallOutcome?
  valueBetProfit    Float?
  valueBetSide      String?

  @@index([matchId])
  @@index([outcome])
  @@index([sport])
  @@index([source])
  @@index([createdAt])
  @@index([conviction])
  @@index([clvFetched])
  @@index([valueBetOutcome])
}

model ScheduledPost {
  id           String       @id @default(cuid())
  content      String
  contentType  PostCategory
  scheduledFor DateTime
  timezone     String       @default("UTC")
  matchId      String?
  predictionId String?
  posted       Boolean      @default(false)
  postedAt     DateTime?
  tweetId      String?
  error        String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([scheduledFor])
  @@index([posted])
  @@index([contentType])
}

model TwitterPost {
  id             String       @id @default(cuid())
  tweetId        String       @unique
  content        String
  category       PostCategory
  threadId       String?
  threadPosition Int?
  likes          Int          @default(0)
  retweets       Int          @default(0)
  replies        Int          @default(0)
  impressions    Int          @default(0)
  postedAt       DateTime     @default(now())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([category])
  @@index([postedAt])
  @@index([threadId])
}

model DailyStats {
  id               String   @id @default(cuid())
  date             DateTime @unique @db.Date
  totalPredictions Int      @default(0)
  hits             Int      @default(0)
  misses           Int      @default(0)
  pushes           Int      @default(0)
  hitRate          Float    @default(0)
  conv1Hits        Int      @default(0)
  conv1Total       Int      @default(0)
  conv2Hits        Int      @default(0)
  conv2Total       Int      @default(0)
  conv3Hits        Int      @default(0)
  conv3Total       Int      @default(0)
  conv4Hits        Int      @default(0)
  conv4Total       Int      @default(0)
  conv5Hits        Int      @default(0)
  conv5Total       Int      @default(0)
  postsCount       Int      @default(0)
  totalLikes       Int      @default(0)
  totalRetweets    Int      @default(0)
  totalImpressions Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([date])
}

model OddsSnapshot {
  id              String   @id @default(cuid())
  matchRef        String
  sport           String
  league          String
  homeTeam        String
  awayTeam        String
  matchDate       DateTime
  homeOdds        Float
  awayOdds        Float
  drawOdds        Float?
  prevHomeOdds    Float?
  prevAwayOdds    Float?
  prevDrawOdds    Float?
  homeChange      Float?
  awayChange      Float?
  drawChange      Float?
  modelHomeProb   Float?
  modelAwayProb   Float?
  modelDrawProb   Float?
  homeEdge        Float?
  awayEdge        Float?
  drawEdge        Float?
  hasSteamMove    Boolean  @default(false)
  hasValueEdge    Boolean  @default(false)
  alertLevel      String?
  alertNote       String?
  bookmaker       String?  @default("consensus")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  openingAwayOdds Float?
  openingDrawOdds Float?
  openingHomeOdds Float?

  @@unique([matchRef, sport, bookmaker])
  @@index([sport])
  @@index([matchDate])
  @@index([hasSteamMove])
  @@index([hasValueEdge])
  @@index([matchRef])
}

enum Plan {
  FREE
  PRO
  PREMIUM
  ADMIN
}

enum KeywordStatus {
  PENDING
  ACTIVE
  EXHAUSTED
  DISABLED
}

enum PostStatus {
  DRAFT
  PUBLISHED
  SCHEDULED
  ARCHIVED
}

enum PostType {
  GENERAL
  MATCH_PREVIEW
  MATCH_RECAP
  MATCH_COMBINED
  NEWS
}

enum CallType {
  MATCH_RESULT
  OVER_UNDER
  BTTS
  PLAYER_PROP
  FIRST_SCORER
  CLEAN_SHEET
  CORNER_COUNT
  CARD_COUNT
  HANDICAP
  DOUBLE_CHANCE
}

enum CallOutcome {
  PENDING
  HIT
  MISS
  PUSH
  VOID
}

enum PredictionSource {
  PRE_ANALYZE
  MATCH_ANALYSIS
  AGENT_POST
}

enum PostCategory {
  MORNING_BRIEFING
  MATCH_PREVIEW
  LIVE_UPDATE
  POST_MATCH
  CALL_VALIDATION
  HOT_TAKE
  TRENDING
  WEEKLY_STATS
  THREAD
  LIVE_INTEL
}

// Short share links for social media
model ShareLink {
  id         String    @id @default(cuid())
  code       String    @unique // Short code like "abc123"
  homeTeam   String
  awayTeam   String
  league     String    @default("Match")
  verdict    String    @default("AI Analysis")
  risk       String    @default("MEDIUM")
  confidence Int       @default(75)
  value      String?   // Best value side
  matchDate  String?
  sport      String    @default("soccer")
  views      Int       @default(0)
  createdAt  DateTime  @default(now())
  expiresAt  DateTime?
  
  @@index([code])
  @@index([createdAt])
}

// Edge Tracking for A/B Testing Model Accuracy
model EdgeTracking {
  id              String        @id @default(cuid())
  predictionId    String
  matchId         String
  sport           String
  league          String
  kickoff         DateTime
  
  // Model outputs
  ourModelHome    Float         // Our model home prob
  ourModelAway    Float         // Our model away prob
  ourModelDraw    Float?        // Our model draw prob
  marketHome      Float         // Market implied home
  marketAway      Float         // Market implied away
  marketDraw      Float?        // Market implied draw
  
  // Ensemble weights used
  ensembleMethod  String        @default("default")  // e.g., "default", "market_heavy", "model_heavy"
  finalHome       Float         // Final blended home prob
  finalAway       Float         // Final blended away prob
  finalDraw       Float?        // Final blended draw prob
  
  // Edge identified
  edgeSide        String        // "home", "away", "draw"
  edgeValue       Float         // Edge percentage
  conviction      Int           // 1-10
  
  // Situational factors used
  situationalAdj  Float         @default(0)  // Net situational adjustment
  trapGameFlag    Boolean       @default(false)
  
  // Outcome tracking
  outcome         CallOutcome   @default(PENDING)
  actualResult    String?
  
  // CLV tracking
  clvPercentage   Float?
  beatingMarket   Boolean?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([sport])
  @@index([ensembleMethod])
  @@index([outcome])
  @@index([createdAt])
}

// Line Movement Tracking & Alerts
model LineMovement {
  id              String        @id @default(cuid())
  matchId         String
  matchName       String
  sport           String
  league          String
  kickoff         DateTime
  
  // Opening snapshot
  openingHome     Float
  openingAway     Float
  openingDraw     Float?
  openingTime     DateTime
  
  // Current/Latest snapshot  
  currentHome     Float
  currentAway     Float
  currentDraw     Float?
  updatedTime     DateTime
  
  // Movement analysis
  homeMovement    Float         // Percentage change
  awayMovement    Float
  drawMovement    Float?
  
  // Alerts
  isSharpMove     Boolean       @default(false)  // 3%+ move detected
  sharpSide       String?       // Which side moved sharply
  alertSent       Boolean       @default(false)
  alertSentAt     DateTime?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([matchId])
  @@index([sport])
  @@index([kickoff])
  @@index([isSharpMove])
  @@index([alertSent])
}
